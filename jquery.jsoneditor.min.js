// Copyright (c) 2011 David Durman
// Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php).
(function(d){function q(a,b,c){a={target:a,onchange:c,original:b};k(a,b,a.target);d(".property, .value",a.target).live("blur focus",function(){d(this).toggleClass("editing")})}function l(a){return Object.prototype.toString.call(a)=="[object Object]"}function m(a){return Object.prototype.toString.call(a)=="[object Array]"}function n(a,b,c){var g=arguments.length==2;if(b.indexOf(".")>-1){for(var e=a,f=0,h=b.split("."),i=h.length;f<i-1;f++)e=e[h[f]];if(g)delete e[h[i-1]];else e[h[i-1]]=c}else if(g)delete a[b];
else a[b]=c;return a}function r(a,b,c){b=b.split(".");for(var g=0;g<b.length;)if((a=a[b[g++]])==undefined)return c;return a}function o(a){if(a.children(".expander").length==0){var b=d("<span>",{"class":"expander"});b.bind("click",function(){d(this).parent().toggleClass("expanded")});a.prepend(b)}}function k(a,b,c,g){g=g||"";c.children(".item").remove();for(var e in b)if(b.hasOwnProperty(e)){var f=d("<div>",{"class":"item","data-path":g}),h=d("<input>",{"class":"property"}),i=d("<input>",{"class":"value"});
if(l(b[e])||m(b[e]))o(f);f.append(h).append(i);c.append(f);h.val(e);i.val(JSON.stringify(b[e]));s(a,b,h,i,e);if(l(b[e])||m(b[e]))k(a,b[e],f,(g?g+".":"")+e)}}function p(a,b){d(a).parentsUntil(b.target).each(function(){var c=d(this).data("path");c=(c?c+".":c)+d(this).children(".property").val();d(this).children(".value").val(JSON.stringify(r(b.original,c,"")))})}function s(a,b,c,g,e){c.change(function(){var f=d(this).parent().data("path"),h=JSON.parse(d(this).next().val());n(a.original,(f?f+".":"")+
e);n(a.original,(f?f+".":"")+d(this).val(),h);p(this,a);a.onchange()});g.change(function(){var f=d(this).prev().val(),h=JSON.parse(d(this).val()),i=d(this).parent(),j=i.data("path");n(a.original,(j?j+".":"")+f,h);if(l(h)||m(h)){k(a,h,i,(j?j+".":"")+f);o(i)}p(this,a);a.onchange()})}d.fn.jsonEditor=function(a,b){var c=function(){},g=b?b.change||c:c;return this.each(function(){q(d(this),a,g)})}})(jQuery);
