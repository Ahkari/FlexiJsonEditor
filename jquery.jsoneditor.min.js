// Simple yet flexible JSON editor plugin.
// Turns any element into a stylable interactive JSON editor.

// Copyright (c) 2013 David Durman

// Licensed under the MIT license (http://www.opensource.org/licenses/mit-license.php).

(function(c){function k(b){return"[object Object]"==Object.prototype.toString.call(b)}function l(b){return"[object Array]"==Object.prototype.toString.call(b)}function m(b,a,f){var e=2==arguments.length;if(-1<a.indexOf(".")){for(var d=b,c=0,h=a.split("."),j=h.length;c<j-1;c++)d=d[h[c]];e?delete d[h[j-1]]:d[h[j-1]]=f}else e?delete b[a]:b[a]=f;return b}function n(b){var a;try{a=JSON.parse(b)}catch(f){a=null,window.console&&console.error("JSON parse failed.")}return a}function p(b){var a;try{a=JSON.stringify(b)}catch(f){a=
"null",window.console&&console.error("JSON stringify failed.")}return a}function r(b){if(0==b.children(".expander").length){var a=c("<span>",{"class":"expander"});a.bind("click",function(){c(this).parent().toggleClass("expanded")});b.prepend(a)}}function q(b,a,f,e){e=e||"";f.children(".item").remove();for(var d in a)if(a.hasOwnProperty(d)){var g=c("<div>",{"class":"item","data-path":e}),h=c(b.propertyElement||"<input>",{"class":"property"}),j=c(b.valueElement||"<input>",{"class":"value"});(k(a[d])||
l(a[d]))&&r(g);g.append(h).append(j);f.append(g);h.val(d).attr("title",d);var m=p(a[d]);j.val(m).attr("title",m);s(g,a[d]);h.change(u(b));j.change(v(b));h.click(w(b));if(k(a[d])||l(a[d]))q(b,a[d],g,(e?e+".":"")+d)}if(k(a)||l(a))d=c("<div>",{"class":"item appender"}),g=c("<button></button>",{"class":"property"}),g.text("Add New Value"),d.append(g),f.append(d),g.click(function(){if(l(a))a.push(null);else if(k(a)){for(var c=1,d="newKey";a.hasOwnProperty(d);)d="newKey"+c,c++;a[d]=null}q(b,a,f,e);b.onchange(n(p(b.original)))})}
function t(b,a){c(b).parentsUntil(a.target).each(function(){var b=c(this).data("path"),b=(b?b+".":b)+c(this).children(".property").val(),e;a:{e=a.original;for(var b=b.split("."),d=0;d<b.length;)if(void 0==(e=e[b[d++]])){e=null;break a}}e=p(e);c(this).children(".value").val(e).attr("title",e)})}function w(b){return function(){var a=c(this).parent().data("path"),f=c(this).attr("title"),a=a?a.split(".").concat([f]).join("']['"):f;b.onpropertyclick("['"+a+"']")}}function u(b){return function(){var a=
c(this).parent().data("path"),f=n(c(this).next().val()),e=c(this).val(),d=c(this).attr("title");c(this).attr("title",e);m(b.original,(a?a+".":"")+d);e&&m(b.original,(a?a+".":"")+e,f);t(this,b);e||c(this).parent().remove();b.onchange(n(p(b.original)))}}function v(b){return function(){var a=c(this).prev().val(),f=n(c(this).val()||"null"),e=c(this).parent(),d=e.data("path");m(b.original,(d?d+".":"")+a,f);(k(f)||l(f))&&!c.isEmptyObject(f)?(q(b,f,e,(d?d+".":"")+a),r(e)):e.find(".expander, .item").remove();
s(e,f);t(this,b);b.onchange(n(p(b.original)))}}function s(b,a){var c="null";k(a)?c="object":l(a)?c="array":"[object Boolean]"==Object.prototype.toString.call(a)?c="boolean":"[object String]"==Object.prototype.toString.call(a)?c="string":"[object Number]"==Object.prototype.toString.call(a)&&(c="number");b.removeClass(x);b.addClass(c)}c.fn.jsonEditor=function(b,a){a=a||{};b=n(p(b));var f=function(){},e=a.change||f,d=a.propertyclick||f;return this.each(function(){var f={target:c(this),onchange:e,onpropertyclick:d,
original:b,propertyElement:a.propertyElement,valueElement:a.valueElement};q(f,b,f.target);c(".property, .value",f.target).live("blur focus",function(){c(this).toggleClass("editing")})})};var x="object array boolean number string null"})(jQuery);